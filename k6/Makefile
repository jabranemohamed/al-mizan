# ============================================
# Al-Mizan â€” K6 Test Runner
# ============================================
# Usage:
#   make smoke                â†’ Smoke test (1 VU, 30s)
#   make load                 â†’ Load test (10 VU, 5 min)
#   make stress               â†’ Stress test (10â†’100 VU)
#   make spike                â†’ Spike test (5â†’100â†’5 VU)
#   make endurance            â†’ Endurance test (20 VU, 30 min)
#   make ai                   â†’ AI advice test (2-5 VU)
#   make breakpoint           â†’ Breakpoint test (0â†’300 VU)
#   make auth                 â†’ Auth test (register/login)
#   make scenario             â†’ Multi-persona scenario
#   make all                  â†’ Smoke â†’ Load â†’ Stress â†’ Spike
#   make full                 â†’ Tous les tests
#   make BASE_URL=http://... load  â†’ URL custom
# ============================================

BASE_URL ?= http://localhost:8080
K6       ?= k6
K6_OPTS  ?=
RESULTS  := results

# Prometheus Remote Write (optionnel, pour Grafana)
# Ajouter: make load K6_OPTS="--out experimental-prometheus-rw"
# Avec:    K6_PROMETHEUS_RW_SERVER_URL=http://localhost:9090/api/v1/write

.PHONY: help smoke load stress spike endurance ai breakpoint auth scenario all full clean

help: ## Affiche cette aide
	@echo ""
	@echo "âš–ï¸  Al-Mizan â€” K6 Performance Tests"
	@echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
	@echo "  BASE_URL = $(BASE_URL)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*##' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*## "}; {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}'
	@echo ""

smoke: ## ğŸ”¥ Smoke test â€” vÃ©rification de base (1 VU, 30s)
	@echo "ğŸ”¥ Running SMOKE test..."
	$(K6) run $(K6_OPTS) -e BASE_URL=$(BASE_URL) scripts/01-smoke.js

load: ## âš–ï¸ Load test â€” charge normale (10 VU, 5 min)
	@echo "âš–ï¸ Running LOAD test..."
	@mkdir -p $(RESULTS)
	$(K6) run $(K6_OPTS) -e BASE_URL=$(BASE_URL) scripts/02-load.js

stress: ## ğŸ’¥ Stress test â€” montÃ©e en charge (10â†’100 VU)
	@echo "ğŸ’¥ Running STRESS test..."
	@mkdir -p $(RESULTS)
	$(K6) run $(K6_OPTS) -e BASE_URL=$(BASE_URL) scripts/03-stress.js

spike: ## âš¡ Spike test â€” pic soudain (5â†’100â†’5 VU)
	@echo "âš¡ Running SPIKE test..."
	@mkdir -p $(RESULTS)
	$(K6) run $(K6_OPTS) -e BASE_URL=$(BASE_URL) scripts/04-spike.js

endurance: ## ğŸ‹ï¸ Endurance test â€” soak (20 VU, 30 min)
	@echo "ğŸ‹ï¸ Running ENDURANCE test..."
	@mkdir -p $(RESULTS)
	$(K6) run $(K6_OPTS) -e BASE_URL=$(BASE_URL) scripts/05-endurance.js

ai: ## ğŸ¤– AI advice test â€” latence OpenAI (2-5 VU)
	@echo "ğŸ¤– Running AI ADVICE test..."
	@mkdir -p $(RESULTS)
	$(K6) run $(K6_OPTS) -e BASE_URL=$(BASE_URL) scripts/06-ai-advice.js

breakpoint: ## ğŸ¯ Breakpoint test â€” trouver la limite (0â†’300 VU)
	@echo "ğŸ¯ Running BREAKPOINT test..."
	@mkdir -p $(RESULTS)
	$(K6) run $(K6_OPTS) -e BASE_URL=$(BASE_URL) scripts/07-breakpoint.js

auth: ## ğŸ” Auth test â€” register/login sous charge (5â†’40 VU)
	@echo "ğŸ” Running AUTH test..."
	@mkdir -p $(RESULTS)
	$(K6) run $(K6_OPTS) -e BASE_URL=$(BASE_URL) scripts/08-auth.js

scenario: ## ğŸ•Œ Scenario test â€” multi-personas rÃ©aliste
	@echo "ğŸ•Œ Running SCENARIO test..."
	@mkdir -p $(RESULTS)
	$(K6) run $(K6_OPTS) -e BASE_URL=$(BASE_URL) scripts/09-scenario.js

all: smoke load stress spike ## ğŸš€ Suite complÃ¨te rapide (smokeâ†’loadâ†’stressâ†’spike)
	@echo "âœ… Suite rapide terminÃ©e â€” rÃ©sultats dans $(RESULTS)/"

full: smoke load stress spike endurance auth breakpoint scenario ## ğŸ† Suite complÃ¨te (tous les tests)
	@echo "âœ… Suite complÃ¨te terminÃ©e â€” rÃ©sultats dans $(RESULTS)/"

# ---- Grafana + Prometheus ----
grafana-load: ## âš–ï¸ Load test avec export Prometheus â†’ Grafana
	@echo "âš–ï¸ Running LOAD test â†’ Prometheus..."
	$(K6) run \
		--out experimental-prometheus-rw \
		-e BASE_URL=$(BASE_URL) \
		-e K6_PROMETHEUS_RW_SERVER_URL=http://localhost:9090/api/v1/write \
		scripts/02-load.js

grafana-stress: ## ğŸ’¥ Stress test avec export Prometheus â†’ Grafana
	@echo "ğŸ’¥ Running STRESS test â†’ Prometheus..."
	$(K6) run \
		--out experimental-prometheus-rw \
		-e BASE_URL=$(BASE_URL) \
		-e K6_PROMETHEUS_RW_SERVER_URL=http://localhost:9090/api/v1/write \
		scripts/03-stress.js

clean: ## ğŸ§¹ Nettoyer les rÃ©sultats
	rm -rf $(RESULTS)/*.json
	@echo "ğŸ§¹ RÃ©sultats nettoyÃ©s"
